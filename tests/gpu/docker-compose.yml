version: "3.9"

services:
  asr_ocr_cuda:
    image: ghcr.io/knowusuboaky/asr_ocr:cuda
    container_name: asr_ocr_cuda
    restart: unless-stopped
    pull_policy: always
    # If you want CPU+GPU running together, change this to "9003:9002" (or stop the CPU one).
    ports:
      - "9002:9002"
    environment:
      - TZ=America/St_Johns
      - HF_HOME=/root/.cache/huggingface
      - HF_HUB_CACHE=/root/.cache/huggingface
      - TRANSFORMERS_CACHE=/root/.cache/huggingface
      # - ASR_MODEL=large-v3
      # - OCR_LANGS=en
      # - VLM_MODEL_ID=microsoft/Florence-2-large
      # - VLM_MAX_TOKENS=768
      - FETCH_UA=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36
      # NVIDIA vars (harmless if already default)
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - hf-cache:/root/.cache/huggingface
      - ctranslate2-cache:/root/.cache/ctranslate2
      - paddle-cache:/root/.paddleocr
    # Compose v2+ GPU flag
    gpus: all
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:9002/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  hf-cache:
  ctranslate2-cache:
  paddle-cache:
